# 名词解释：MAC

## 定义

*MAC* 代表*媒体访问控制*。媒体访问控制是一种网络数据传输策略，它决定数据如何通过网线在两个计算机终端之间传输。媒体访问控制策略涉及 OSI 参考模型中数据链路层 2 的子层。这种在终端节点之间传输数据以避免碰撞的网络信道有不同的方法来实现这一目的。它们包括

- 具有避免碰撞功能的载波侦测多路存取（CSMA/CA）
- 具有碰撞检测功能的载波侦测多路存取（CSMA/CD）
- 需求优先
- 令牌传递

*MAC 地址*是制造商为网络硬件(如无线网卡或以太网网卡)分配的唯一代码，由六组两位的十六进制数字组成（例如：00:A0:C9:14:C8:29），总共48位长。 在数据链路层的以太网通信协议中，MAC地址起到了重要的作用。每当计算机或者任何网络设备尝试通信时，它都会使用MAC地址来确保信息能够被准确地送达到正确的目标设备上。



`总结`：MAC是介质访问控制(Media Access Control)，是一种网络数据传输策略，它决定了数据如何通过传输介质在两个主机之间传输。属于OSI模型中数据链路层的子层。可以通过`载波监听多址接入/碰撞检测`和`载波监听多址接入/碰撞避免`等方法来控制数据传输。OSI 数据链接层中用来`决定广播信道中 信道分配协议`的子层。MAC 地址是 OSI 中对应数据链路层的地址，每个网络位置 都有一个唯一的编号。MAC 为使用介质的每个节点隔离来自同一信道上其他节点 所传送的信号，以协调活动节点的传输。













# 名词解释： ISDN

## 定义

**综合业务数字网(Integrated Services Digital Network)**。**综合业务数字网是以综合数字网（IDN）为基础发展而成的通信网，它能提供端到端的数字连接，用来承载包括话音和非话音在内的多种电信业务，用户能够通过有限的一组标准多用途用户/网络接口接入这个网络。**















# 名词解释： OSPF

**开放最短路径优先(Open Shortest Path First)。基于分布式的链路状态协议，适 用于大型互联网。OSPF 只在链路状态发生变化时，才用向本自治系统内的所有路 由器用洪泛法发送与本路由器相邻的所有路由器的链路状态信息，链路状态路由协议使用SPF最短路经优先算法（shortest path first spf）计算和选择路由，这类路由协议只关心网络中链路或接口的状态（up down ip地址，掩码带宽，利用率和时延等），每个路由器将已知的链路状态信息向该区域的其他路由器通告，通过这种方式，网络上的每台路由器对网络结构都会有相同的认识，随后路由器以其为依据，使用spf算法计算和选择路由，最终了解全网的 拓扑结构图。**

## **OSPF定义**

OSPF（Open Shortest Path First，开放最短路径优先）是IETF（Internet Engineering Task Force，互联网工程任务组）组织开发的一个基于链路状态的自治系统内部网关协议。目前针对IPv4协议使用的是OSPF Version 2。ospf直接工作在ip层之上，ip协议号89，ospf以组播方式发送协议包！

链路状态路由协议使用SPF最短路经优先算法（shortest path first spf）计算和选择路由，这类路由协议只关心网络中链路或接口的状态（up down ip地址，掩码带宽，利用率和时延等），每个路由器将已知的链路状态信息向该区域的其他路由器通告，通过这种方式，网络上的每台路由器对网络结构都会有相同的认识，随后路由器以其为依据，使用spf算法计算和选择路由

***spf算法：**是以自身为根节点计算出一棵最短路径树，在这棵树上由根到各节点的累计开销最小*

*即由根到各节点的路径在整个网络中都是最优的，这样也就获得了由根去往各个节点的路由。*

*ospf引入router id概念，ospf区域内的每台路由器的行为都能很好的被跟踪*

## **OSPF协议基本原理**

`工作过程：邻居发现 → 路由交换 → 路由计算 → 路由维护`

1、邻居表：记录所有建立了邻居关系的路由器，包括相关描述和邻居状态。会定期的相互发送hello报文来维护，若在一定的周期内没有收到领居回应的hello报文，则认为邻居路由器失效，将它从邻居表中删除

2、链路状态数据库表（LSDB）：此表里包含了网络拓扑中链路状态的通告。**每台路由器在同一个区域内LSDB表一样**

3、路由表：在获得完整LSDB表后，进行SPF算法，形成最优路由加入路由表

## OSPF路由器间组播

ospf是以组播地址发送协议包，只有加入了ospf区域的接口地址才会接受和发送组播地址发送的ospf报文（224.0.0.6指代一个多路访问网络中DR和BDR的组播接收地址，224.0.0.5指代在任意网络中所有运行OSPF进程的接口都属于该组，于是接收所有224.0.0.5的组播数据包。

重点理解好 属于某一组 和 接收怎样的组播数据包，

比如 DR/BDR属于[组播地址](https://link.zhihu.com/?target=https%3A//www.baidu.com/s%3Fwd%3D%E7%BB%84%E6%92%AD%E5%9C%B0%E5%9D%80%26tn%3DSE_PcZhidaonwhc_ngpagmjz%26rsv_dl%3Dgh_pc_zhidao)为224.0.0.6的组（Group），因此它接收目的地址为224.0.0.6的组播数据包，也就可以理解为何多路访问通过设置DR/BDR可以防止信息过多处理（因为属于某组的接收者（指OSPF接口），只会剥离到二层，而不会进一步处理，也就省去了很多资源浪费）。 ）

![img](https://pic3.zhimg.com/80/v2-9811f9b68fae4a4542cd6fb595c4a676_1440w.webp)

## **OSPF支持的网络类型**

根据路由器所连接的物理网络不同，OSPF将网络划分为四种类型：广播多路访问型（Broadcast multiAccess）、非广播多路访问型（None Broadcast MultiAccess，NBMA）、点到点型（Point-to-Point）、点到多点型（Point-to-MultiPoint）。

广播多路访问型网络如：Ethernet、Token Ring、FDDI。NBMA型网络如：Frame Relay、X.25、SMDS。Point-to-Point型网络如：PPP、HDLC。

**指派路由器（DR）和备份指派路由器（BDR）**

在多路访问网络上可能存在多个路由器，为了避免路由器之间建立完全相邻关系而引起的大量开销，OSPF要求在区域中选举一个DR。每个路由器都与之建立完全相邻关系。DR负责收集所有的链路状态信息，并发布给其他路由器。选举DR的同时也选举出一个BDR，在DR失效的时候，BDR担负起DR的职责。

点对点型网络不需要DR，因为只存在两个节点，彼此间完全相邻。 协议组成OSPF协议由Hello协议、交换协议、扩散协议组成。本文仅介绍Hello协议，其他两个协议可参考RFC2328中的具体描述。

当路由器开启一个端口的OSPF路由时，将会从这个端口发出一个Hello报文，以后它也将以一定的间隔周期性地发送Hello报文。OSPF路由器用Hello报文来初始化新的相邻关系以及确认相邻的路由器邻居之间的通信状态。

对广播型网络和非广播型多路访问网络，路由器使用Hello协议选举出一个DR。在广播型网络里，Hello报文使用多播地址224.0.0.5周期性广播，并通过这个过程自动发现路由器邻居。在NBMA网络中，DR负责向其他路由器逐一发送Hello报文。



## **区域**

OSPF协议引入“分层路由”的概念，将网络分割成一个“主干”连接的一组相互独立的部分，这些相互独立的部分被称为“区域”(Area)，“主干”的部分称为“主干区域”。每个区域就如同一个独立的网络，该区域的OSPF路由器只保存该区域的链路状态。每个路由器的链路状态数据库都可以保持合理的大小，路由计算的时间、报文数量都不会过大。

共有**五种区域**的主要区别在于它们和外部路由器间的关系：

标准区域: 一个标准区域可以接收链路更新信息和路由总结。

主干区域(传递区域):主干区域是连接各个区域的中心实体。主干区域始终是“区域0”，所有其他的区域都要连接到这个区域上交换路由信息。主干区域拥有标准区域的所有性质。

存根区域（stub Area）：存根区域是不接受自治系统以外的路由信息的区域。如果需要自治系统以外的路由，它使用默认路由0.0.0.0。

完全存根区域：它不接受外部自治系统的路由以及自治系统内其他区域的路由总结。需要发送到区域外的报文则使用默认路由：0.0.0.0。**完全存根区域是Cisco自己定义的**。

不完全存根区域(NSAA): 它类似于存根区域，但是允许接收以LSA Type 7发送的外部路由信息，并且要把LSA Type 7转换成LSA Type 5。







## **OSPF协议报文**

![img](https://pic3.zhimg.com/80/v2-4acc720483c7282a391e8e02bcbe84f2_1440w.webp)







## **OSPF路由的计算过程和邻接关系的建立与维持**

**OSPF协议路由生成过程**

1、`生成LSA`描述自己的接口状态（Link-State Advertisement 链路状态通告）

每台路由器都根据自己周围的接口状态生成LSA（接口状态up或down）、链路开销、IP地址/子网掩码链路开销与接口带宽成反比

2、`同步`ospf区域内的每台路由器的`LSDB`

ospf路由器通过交换LSA来实现LSDB的同步

3、使用spf计算路由

ospf路由器用spf算法以自身为根节点`计算出一棵最短路径树`

如果通过SPF算法发现到达同一目标的路径cost值相同，就将两条路由同时加入路由表，形成等价路由

![img](https://pic2.zhimg.com/80/v2-4ce128e1a1ab8f098dc09f51cb2dd44d_1440w.webp)







## DR的选举

**DR选举过程：**

1，本网段的ospf路由器

2，本网段priority>0的ospf路由器

3，所有的priority>0的ospf路由器都认为自己是DR

4，选priority值最大的，若priority值相等，选route-id最大的

**DR选举特点：**

1，DR是各路由器选出来的，而非人工指定的。

2，DR一旦当选，除非路由器故障，否而不会更换，即便新加入一台优先级比DR高的路由器，也不换。

3，DR选出的同时，也选出BDR来





## 邻接关系的形成与维持

通过hello报文形成邻接关系

邻居建立后，还需要hello报文进行邻居关系的维持，有两个定时器来进行这项工作：

1，hello time：缺省10s（nbma网络30s）

2，dead time：缺省40s

### **邻居关系和邻接关系的建立：**

**邻居发现与维护**

a、两台路由器以组播的方式（224.0.0.5）发送ospf协议的hello报文（Router ID、相关参数协商信息）。组播地址224.0.0.5表示所有运行ospf路由器都能收到该报文。*（224.0.0.5是DR和BDR发送报文给DRother时用，224.0.0.6是DR和BDR监听DRother时用（实验表明都是用224.0.0.5））*


b、两台路由器根据收到的报文，进行参数协商，如果验证、区域等参数都设置一致，则认为发现邻居


c、发现邻居后，进行维护。邻居之间周期性（10s）的交互hello报文
在一定时间内，内收到邻居发来的报文，认为邻居正常，反则认为失效。


d、ospf定时器：
hello定时器（10s）：接口向邻居发送hello报文的间隔。邻居之间定时器要保持一致，且与路由的收敛速度、网络负荷大小成反比

邻居失效时间 （40s）：在邻居失效时间内，如果接口还没有收到hello报文，则宣告邻居无效非广播网络中，每隔30秒发送一次，保持时间120秒






## **LSDB的更新：**

![img](https://pic4.zhimg.com/80/v2-6de36cc02dccccd60780f8db7d3a5277_1440w.webp)



- 老化时间：LSDB里面的LSA都设定了老化时间，默认为1h，如果1h内LSA没有被更新，LSA在LSDB表中将会被移除。LSDB每隔0.5h刷新一次所有的LSA，LSA的序列号都会加一
- 序列号越大，表示LSA越新；老化时间越小，表示LSA越新，默认每0.5h进行一次LSA的泛洪。

注意：校验和是不能体现LSA的新旧。

![img](https://pic2.zhimg.com/80/v2-baac2ddcc4906d39e1848c40b6080b81_1440w.webp)



（1）、RTA发现链路状态发生改变后，以组播地址为（224.0.0.6）将LSU报文发送给RTC和RTD。组播地址224.0.0.6表示只有DR和BDR能够接收到这个报文

（2）、RTC作为DR，收到报文后，发送LSAack报文确认，同时使用组播地址为224.0.0.5将LSU报文发送给所有OSPF的路由器。



骨干区域与虚连接

OSPF划分区域之后，并非所有的区域都是平等的关系。其中有一个区域是与众不同的，它的区域号是0，通常被称为骨干区域。骨干区域负责区域之间的路由，非骨干区域之间的路由信息必须通过骨干区域来转发。对此，OSPF有两个规定：

· 所有非骨干区域必须与骨干区域保持连通；

· 骨干区域自身也必须保持连通。

在实际应用中，可能会因为各方面条件的限制，无法满足上面的要求。这时可以通过配置OSPF虚连接予以解决。

(2) 虚连接（Virtual Link）

虚连接是指在两台ABR之间通过一个非骨干区域而建立的一条逻辑上的连接通道。它的两端必须是ABR，而且必须在两端同时配置方可生效。为虚连接两端提供一条非骨干区域内部路由的区域称为传输区（Transit Area）。















# 名词解释： RIP

## **RIP简介**

**定义**

RIP是Routing Information Protocol（路由信息协议）的简称，它是一种较为简单的内部网关协议（Interior Gateway Protocol）。RIP是一种基于距离矢量（Distance-Vector）算法的协议，它`使用跳数（Hop Count）作为度量`来衡量到达目的网络的距离。`RIP通过UDP报文进行路由信息的交换，使用的端口号为520。`

RIP包括RIP-1和RIP-2两个版本，RIP-2对RIP-1进行了扩充，使其更具有优势。

**目的**

由于RIP的实现较为简单，在配置和维护管理方面也远比OSPF和IS-IS容易，因此`RIP主要应用于规模较小的网络中`，例如校园网以及结构较简单的地区性网络。对于更为复杂的环境和大型网络，一般不使用RIP协议

## **RIP基本原理：**

RIP是一种基于距离矢量（Distance-Vector）算法的协议，它使用跳数（Hop Count）作为度量值来衡量到达目的地址的距离。在RIP网络中,RIP协议要求网络中每一台路由器都要维护从自身到每一个目的网络的路由信息。RIP协议使用跳数来衡量网络间的“距离”：从一台路由器到其直连网络的跳数定义为1，从一台路由器到其非直连网络的距离定义为每经过一个路由器则距离加1。“距离”也称为“跳数”RIP允许路由的最大跳数为15，因此，16即为不可达。可见RIP协议只适用于小型网络。

### **RIPv1的特点：**

1. 有类别路由协议。
2. 广播更新。
3. 基于UDP，端口号520。

### **RIP工作过程分析：**

![动图封面](https://pic4.zhimg.com/v2-6c0aa4b19512ddd88b3c2ed3ed1ea937_b.jpg)



图：RIP路由表形成过程

1. RIP协议启动之后RouterA会向相邻的交换机广播一个Request报文。
2. RouterB从接口接收到RouterA发送的Request报文后，把自己的RIP路由表封装在Response报文内，然后向该接口对应的网络广播。
3. RouterA根据RouterB发送的Response报文，形成自己的路由表。
4. RIP按照路由通告进行路由更新和路由选择。这种情况下交换机并不了解整个网络的拓扑，只知道到达目的网络的距离，以及到达目的网络应该走哪个方向或者哪个接口。
5. 如[图2](mk:@MSITStore:D:\Desktop\交换机产品手册.chm::/dc/dc_feature_rip_0004.html#dc_feature_rip_0004__fig_dc_feature_rip_000403)所示，RouterB收到了来自RouterA的路由通告，此时RouterB知道经过RouterA可以到达192.168.1.0/24网络，度量值是1跳，除此之外RouterB不知道其他的信息。即使这个通告因为某种原因已经是错误的信息，RouterB依然认为经过RouterA可以到达192.168.1.0/24网络，度量值是1。这是导致RIP网络容易产生路由环路的最根本原因。

![img](https://pic1.zhimg.com/80/v2-877a85e95f6d78f684e7ed76065621ac_1440w.webp)





###### 案例1

![img](https://ask.qcloudimg.com/http-save/3264435/53c594891f7012d3013e4e2b4974d376.png)

如上图，R1现在要和R4进行通信，目前有三个链路：

- 链路1：R1 -> R2 -> R3 -> R4
- 链路2：R1 -> R5 -> R6 -> R7 -> R4
- 链路3：R1 -> R8 -> R4

这个时候我们可以很直观的看出每条链路的跳数：

- 链路1：3跳
- 链路2：4跳
- 链路3：2跳

看跳数最好最快的办法就是一条链路就是一跳，如下图：

![img](https://ask.qcloudimg.com/http-save/3264435/8b5a321797f2fbd8718e54376a3e1864.png)

那么答案毫无悬念：选择**跳数最小**的链路3：

![img](https://ask.qcloudimg.com/http-save/3264435/4ce5b6fbbf0e6fea603c6168dd50243c.png)

###### 案例2

案例1是链路的跳数都不一样，那加入跳数一样的情况，RIP如何选路的呢？

![img](https://ask.qcloudimg.com/http-save/3264435/0b8e2d3f3bd214600c97d9b7f7a245c5.png)

如上图，R1现在要和R4进行通信，目前有两个链路：

- 链路1：R1 -> R2 -> R3 -> R4
- 链路2：R1 -> R5 -> R6 -> R4

这个时候我们可以很直观的看出每条链路的跳数：

- 链路1：3跳
- 链路2：3跳

上面我们提到过，RIP在计算路由成本时**不使用**其他路由指标，例如负载、带宽、延迟。所以这里起到了[负载均衡](https://cloud.tencent.com/product/clb?from_column=20065&from=20065)的作用，网络将同时向两条路由发送数据。

![img](https://ask.qcloudimg.com/http-save/3264435/f898d7fbca64f3a50362b90e59c012b8.png)









**RIP的更新与维护：**

RIP协议在更新和维护路由信息时主要使用四个定时器：

- 更新定时器（Update timer）：当此定时器超时时，立即发送更新报文。
- 老化定时器（Age timer）：RIP设备如果在老化时间内没有收到邻居发来的路由更新报文，则认为该路由不可达。
- 垃圾收集定时器（Garbage-collect timer）：如果在垃圾收集时间内不可达路由没有收到来自同一邻居的更新，则该路由将被从RIP路由表中彻底删除。
- 抑制定时器（Suppress timer）：当RIP设备收到对端的路由更新，其cost为16，对应路由进入抑制状态，并启动抑制定时器。为了防止路由震荡，在抑制定时器超时之前，即使再收到对端路由cost小于16的更新，也不接受。当抑制定时器超时后，就重新允许接受对端发送的路由更新报文。

**RIP路由与定时器之间的关系：**

- RIP的更新信息发布是由更新定时器控制的，**默认为每30秒**发送一次。
- 每一条路由表项对应两个定时器：老化定时器和垃圾收集定时器。当学到一条路由并添加到RIP路由表中时，老化定时器启动。如果老化定时器超时，设备仍没有收到邻居发来的更新报文，则把该路由的度量值置为16（表示路由不可达），并启动垃圾收集定时器。如果垃圾收集定时器超时，设备仍然没有收到更新报文，则在RIP路由表中删除该路由。

注意事项：

- 如果设备不具有触发更新功能，一个路由表项最多需要300秒才能被删除（老化时间+垃圾收集时间）。
- 如果存在触发更新，那么一个路由条目最多需要120秒才能被删除（即为垃圾收集时间）。

### **触发更新：**

触发更新可以缩短网络收敛时间。在路由表项变化时立即向其他设备广播该信息，而不必等待定时更新。如果没有触发更新，缺省情况下，失效的路由条目会在路由表停留最多300秒（老化定时器+垃圾收集定时器）。



## **RIP的特性：**

### **水平分割：**

水平分割（Split Horizon）的原理是，`RIP从某个接口学到的路由，不会从该接口再发回给邻居路由器`。这样不但减少了带宽消耗，还可以防止路由环路。

水平分割在不同网络中实现有所区别，分为按照接口和按照邻居进行水平分割。

`水平分割防止向始发路由器通告相同的路由。`

举个栗子：

现在有一个小型的网络，三台路由器：R1、R2、R3，R1和R2之间的网段为172.16.1.0/24：

![img](https://ask.qcloudimg.com/http-save/3264435/0c2e75e3ff171fe998629fa5d55f4c8f.png)

现在R2要将172.16.1.0/24宣告给R3：

![img](https://ask.qcloudimg.com/http-save/3264435/0cc37374de1ef0a37cc2c5c49909bfd3.png)

R3收到该路由信息后更新其路由表，因为RIP的刷新定时器为30秒，所以30秒后，R3开始将自己的路由表信息广播通告给附近所有的路由器，包括R2:

![img](https://ask.qcloudimg.com/http-save/3264435/d137e5178e6ad8e487b63b6000760628.png)

这样一来，R2和R3就会不停的向对方互发172.16.1.0/24路由协议，形成了一个环路：

![img](https://ask.qcloudimg.com/http-save/3264435/c4cfd370dff00873e5d45ef7e0616f3d.png)

水平分割防止这种类型在网络中循环，R3 知道R2 早先广播了网络172.16.1.0/24，因此R3 不会将此更新发送给R2：

![img](https://ask.qcloudimg.com/http-save/3264435/a56998c4c5d5a469a6a362d6722b5a8c.png)

这样就避免了环路。

这就是水平分割。

### **毒性反转：**

毒性反转（Poison Reverse）的原理是，RIP从某个接口学到路由后，从原接口发回邻居路由器，并将该路由的开销设置为16（即指明该路由不可达）。利用这种方式，可以清除对方路由表中的无用路由。

配置毒性反转后，RouterB在接收到从RouterA发来的路由后，向RouterA发送一个这条路由不可达的消息（将该路由的开销设置为16），这样RouterA就不会再从RouterB学到这条可达路由，因此就可以避免路由环路的产生。

举个栗子：

![img](https://ask.qcloudimg.com/http-save/3264435/89cedae88d4020df28fa89035c37f5f1.png)

还是这个拓扑图，假如这个时候172.16.1.0/24网段发生故障，这个时候只有R2知道这个事：

![img](https://ask.qcloudimg.com/http-save/3264435/42a84659f02b31826098839bae0f8bdb.png)

假如R2上配置了毒性反转，那么此时会把172.16.1.0/24的跳数变为16，广播给其他路由器，也就是R3：

![img](https://ask.qcloudimg.com/http-save/3264435/a87f99108dbe5f0c651c45a67645f943.png)

R3一看172.16.1.0/24的跳数为16，代表路由不可达，就知道172.16.1.0/24这条路行不通了，但是这还是一条路由信息，随机广播给其他路由器，这样就跟毒性一样传播了，所有的路由器都知道了172.16.1.0/24网络不可达，避免了环路。

这就是毒性反转。

### **水平分割和毒性反转的区别：**

水平分割和毒性逆转都是为了防止RIP中的路由环路而设计的，但是水平分割是不将收到路由条目再按“原路返回”来避免环路，而毒性逆转遵循“坏消息比没消息好”的原则，即将路由条目按“原路返回”，但是该路由条目被标记为不可达（度量值为16）。

缺省情况下不使能毒性逆转。一般情况下，在华为设备中均使能水平分割（除NBMA网络外）而禁用毒性逆转。



















# 名词解释：VLAN

虚拟局域网(Virtual Local Area Network)。是一组逻辑上的设备和用户，这些 设备和用户并不受物理位置的限制，可以根据功能、部门及应用等因素将它们组织 起来，相互之间的通信就好像它们在同一个网段中一样，由此得名虚拟局域网。用 于划分逻辑子网。工作在第二层和第三层。`可以分割广播域。`

**对比**

网桥：分割碰撞域，不分割广播域

交换机：分割碰撞域，不分割广播域

使用了VLAN的交换机：分割碰撞域和广播域

路由器：分割碰撞域和广播域



## **为什么需要VLAN**

### 1.1、什么是VLAN？ 

VLAN（Virtual LAN），翻译成中文是“虚拟局域网”。LAN可以是由少数几台家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。

在此让我们先复习一下广播域的概念。广播域，指的是广播帧（目标MAC地址全部为1）所能传递到的范围，亦即能够直接通信的范围。严格地说，并不仅仅是广播帧，多播帧（Multicast Frame）和目标不明的单播帧（Unknown Unicast Frame）也能在同一个广播域中畅行无阻。

本来，二层交换机只能构建单一的广播域，不过使用VLAN功能后，它能够将网络分割成多个广播域。

### 1.2、未分割广播域时将会发生什么？

那么，为什么需要分割广播域呢？那是因为，如果仅有一个广播域，有可能会影响到网络整体的传输性能。具体原因，请参看附图加深理解。

![VLAN1.png](https://ask.qcloudimg.com/http-save/3893317/ctv9c23iz7.png)

VLAN1.png

图中，是一个由5台二层交换机（交换机1～5）连接了大量客户机构成的网络。假设这时，计算机A需要与计算机B通信。在基于以太网的通信中，必须在数据帧中指定目标MAC地址才能正常通信，因此计算机A必须先广播“ARP请求（ARP Request）信息”，来尝试获取计算机B的MAC地址。

交换机1收到广播帧（ARP请求）后，会将它**转发给除接收端口外的其他所有端口**，也就是**Flooding（泛洪）**了。接着，交换机2收到广播帧后也会Flooding。交换机3、4、5也还会Flooding。最终ARP请求会被转发到同一网络中的所有客户机上。

![VLAN2.png](https://ask.qcloudimg.com/http-save/3893317/vo6av2su93.png)

VLAN2.png

这个ARP请求原本是为了获得计算机B的MAC地址而发出的。也就是说：只要计算机B能收到就万事大吉了。可是事实上，数据帧却传遍整个网络，导致所有的计算机都收到了它。如此一来，一方面广播信息消耗了网络整体的带宽，另一方面，收到广播信息的计算机还要消耗一部分CPU时间来对它进行处理。造成了网络带宽和CPU运算能力的大量无谓消耗。



### 1.3广播信息是那么经常发出的吗？

**广播信息真是那么频繁出现的吗？**

**答案是：是的！**实际上广播帧会非常频繁地出现。利用TCP/IP协议栈通信时，**除了前面出现的ARP外，还有可能需要发出DHCP、RIP等很多其他类型的广播信息。**

ARP广播，是在需要与其他主机通信时发出的。当客户机请求DHCP[服务器](https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065)分配IP地址时，就必须发出DHCP的广播。而使用RIP作为路由协议时，每隔30秒路由器都会对邻近的其他路由器广播一次路由信息。RIP以外的其他路由协议使用多播传输路由信息，这也会被交换机转发（Flooding）。除了TCP/IP以外，NetBEUI、IPX和Apple Talk等协议也经常需要用到广播。例如在Windows下双击打开“网络计算机”时就会发出广播（多播）信息。（Windows XP除外……）

总之，广播就在我们身边。下面是一些常见的广播通信：

 ■ ARP请求：建立IP地址和MAC地址的映射关系。

 ■ RIP：一种路由协议。

 ■ DHCP：用于自动设定IP地址的协议。

 ■ NetBEUI：Windows下使用的网络协议。

 ■ IPX：Novell Netware使用的网络协议。

 ■ Apple Talk：苹果公司的Macintosh计算机使用的网络协议。

如果整个网络只有一个广播域，那么一旦发出广播信息，就会传遍整个网络，并且对网络中的主机带来额外的负担。因此，在设计LAN时，需要注意如何才能有效地分割广播域。



### 1.4广播域的分割与VLAN的必要性

分割广播域时，一般都必须使用到路由器。使用路由器后，可以以路由器上的网络接口（LAN Interface）为单位分割广播域。

但是，通常情况下路由器上不会有太多的网络接口，其数目多在1～4个左右。随着宽带连接的普及，宽带路由器（或者叫IP共享器）变得较为常见，但是需要注意的是，它们上面虽然带着多个（一般为4个左右）连接LAN一侧的网络接口，但那实际上是路由器内置的交换机，并不能分割广播域。

况且使用路由器分割广播域的话，所能分割的个数完全取决于路由器的网络接口个数，使得用户无法自由地根据实际需要分割广播域。

与路由器相比，二层交换机一般带有多个网络接口。因此如果能使用它分割广播域，那么无疑运用上的灵活性会大大提高。

用于在二层交换机上分割广播域的技术，就是VLAN。通过利用VLAN，我们可以自由设计广播域的构成，提高网络设计的自由度。















## **二、实现VLAN的机制**

### 2.1、实现VLAN的机制

在理解了“为什么需要VLAN”之后，接下来让我们来了解一下交换机是如何使用VLAN分割广播域的。

首先，在一台未设置任何VLAN的二层交换机上，任何广播帧都会被转发给除接收端口外的所有其他端口（Flooding）。例如，计算机A发送广播信息后，会被转发给端口2、3、4。

![VLAN3.png](https://ask.qcloudimg.com/http-save/3893317/gnf1j8lr88.png)

VLAN3.png

这时，如果在交换机上生成红、蓝两个VLAN；同时设置端口1、2属于红色VLAN、端口3、4属于蓝色VLAN。再从A发出广播帧的话，交换机就只会把它转发给同属于一个VLAN的其他端口——也就是同属于红色VLAN的端口2，不会再转发给属于蓝色VLAN的端口。

同样，C发送广播信息时，只会被转发给其他属于蓝色VLAN的端口，不会被转发给属于红色VLAN的端口。

![VLAN4.png](https://ask.qcloudimg.com/http-save/3893317/sg30gmaw6v.png)

VLAN4.png

就这样，VLAN通过限制广播帧转发的范围分割了广播域。上图中为了便于说明，以红、蓝两色识别不同的VLAN，在实际使用中则是用“VLAN ID”来区分的。

### 2.2、直观地描述VLAN

如果要更为直观地描述VLAN的话，我们可以把它理解为将一台交换机在逻辑上分割成了数台交换机。在一台交换机上生成红、蓝两个VLAN，也可以看作是将一台交换机换做一红一蓝两台虚拟的交换机。

![VLAN5.png](https://ask.qcloudimg.com/http-save/3893317/ir0sg2nran.png)

VLAN5.png

在红、蓝两个VLAN之外生成新的VLAN时，可以想象成又添加了新的交换机。

但是，VLAN生成的逻辑上的交换机是互不相通的。因此，在交换机上设置VLAN后，如果未做其他处理，VLAN间是无法通信的。

明明接在同一台交换机上，但却偏偏无法通信——这个事实也许让人难以接受。但它既是VLAN方便易用的特征，又是使VLAN令人难以理解的原因。

### 2.3、需要VLAN间通信时怎么办？

那么，当我们需要在不同的VLAN间通信时又该如何是好呢？

请大家再次回忆一下：VLAN是广播域。而通常两个广播域之间由路由器连接，广播域之间来往的数据包都是由路由器中继的。因此，VLAN间的通信也需要路由器提供中继服务，这被称作`“VLAN间路由”`。

VLAN间路由，可以使用普通的路由器，也可以使用`三层交换机`。













## **三、VLAN的访问链接**

### 3.1、交换机的端口

交换机的端口，可以分为以下两种：

■ 访问链接（Access Link）

■ 汇聚链接（Trunk Link）

接下来就让我们来依次学习这两种不同端口的特征。这一讲，首先学习“访问链接”。

### 3.2、访问链接

访问链接，指的是“只属于一个VLAN，且仅向该VLAN转发数据帧”的端口。在大多数情况下，访问链接所连的是客户机。

通常设置VLAN的顺序是：

●生成VLAN

●设定访问链接（决定各端口属于哪一个VLAN）

设定访问链接的手法，可以是事先固定的、也可以是根据所连的计算机而动态改变设定。前者被称为“静态VLAN”、后者自然就是“动态VLAN”了。

#### 3.2.1、静态VLAN

静态VLAN又被称为基于端口的VLAN（Port Based VLAN）。顾名思义，就是明确指定各端口属于哪个VLAN的设定方法。

![VLAN6.png](https://ask.qcloudimg.com/http-save/3893317/v8rp3v3h0r.png)

VLAN6.png

由于需要一个个端口地指定，因此当网络中的计算机数目超过一定数字（比如数百台）后，设定操作就会变得烦杂无比。并且，客户机每次变更所连端口，都必须同时更改该端口所属VLAN的设定——这显然静态VLAN不适合那些需要频繁改变拓补结构的网络。

#### 3.2.2、动态VLAN

另一方面，动态VLAN则是根据每个端口所连的计算机，随时改变端口所属的VLAN。这就可以避免上述的更改设定之类的操作。动态VLAN可以大致分为3类：

● 基于MAC地址的VLAN（MAC Based VLAN）

● 基于子网的VLAN（Subnet Based VLAN）

● 基于用户的VLAN（User Based VLAN）

其间的差异，主要在于根据OSI参照模型哪一层的信息决定端口所属的VLAN。

①、基于MAC地址的VLAN，就是通过查询并记录端口所连计算机上网卡的MAC地址来决定端口的所属。假定有一个MAC地址“A”被交换机设定为属于VLAN“10”，那么不论MAC地址为“A”的这台计算机连在交换机哪个端口，该端口都会被划分到VLAN10中去。计算机连在端口1时，端口1属于VLAN10；而计算机连在端口2时，则是端口2属于VLAN10。

![VLAN7.png](https://ask.qcloudimg.com/http-save/3893317/4vwm5fwuua.png)

VLAN7.png

②、基于子网的VLAN，则是通过所连计算机的IP地址，来决定端口所属VLAN的。不像基于MAC地址的VLAN，即使计算机因为交换了网卡或是其他原因导致MAC地址改变，只要它的IP地址不变，就仍可以加入原先设定的VLAN。

因此，与基于MAC地址的VLAN相比，能够更为简便地改变网络结构。IP地址是OSI参照模型中第三层的信息，所以我们可以理解为基于子网的VLAN是一种在OSI的第三层设定访问链接的方法。

③、基于用户的VLAN，则是根据交换机各端口所连的计算机上当前登录的用户，来决定该端口属于哪个VLAN。这里的用户识别信息，一般是计算机操作系统登录的用户，比如可以是Windows域中使用的用户名。这些用户名信息，属于OSI第四层以上的信息。

总的来说，决定端口所属VLAN时利用的信息在OSI中的层面越高，就越适于构建灵活多变的网络。

#### 3.2.3、访问链接的总结

综上所述，设定访问链接的手法有静态VLAN和动态VLAN两种，其中动态VLAN又可以继续细分成几个小类。

其中基于子网的VLAN和基于用户的VLAN有可能是网络设备厂商使用独有的协议实现的，不同厂商的设备之间互联有可能出现兼容性问题；因此在选择交换机时，一定要注意事先确认。

下表总结了静态VLAN和动态VLAN的相关信息。

| 种类                       | 解说                             |                                   |
| :------------------------- | :------------------------------- | --------------------------------- |
| 静态VLAN（基于端口的VLAN） | 将交换机的各端口固定指派给VLAN   |                                   |
| 动态VLAN                   | 基于MAC地址的VLAN                | 根据各端口所连计算机的MAC地址设定 |
| 基于子网的VLAN             | 根据各端口所连计算机的IP地址设定 |                                   |
| 基于用户的VLAN             | 根据端口所连计算机上登录用户设定 |                                   |











## **四、VLAN的汇聚链接**

### 4.1、设置跨越多台交换机的VLAN

到此为止，我们学习的都是使用单台交换机设置VLAN时的情况。那么，如果需要设置跨越多台交换机的VLAN时又如何呢？

在规划企业级网络时，很有可能会遇到隶属于同一部门的用户分散在同一座建筑物中的不同楼层的情况，这时可能就需要考虑到如何跨越多台交换机设置VLAN的问题了。假设有如下图所示的网络，且需要将不同楼层的A、C和B、D设置为同一个VLAN。

![VLAN8.png](https://ask.qcloudimg.com/http-save/3893317/spp6rng9kz.png)

VLAN8.png

这时最关键的就是“交换机1和交换机2该如何连接才好呢？”

最简单的方法，自然是在交换机1和交换机2上各设一个红、蓝VLAN专用的接口并互联了。

![VLAN9.png](https://ask.qcloudimg.com/http-save/3893317/h1gwdf9s0y.png)

VLAN9.png

但是，这个办法从扩展性和管理效率来看都不好。例如，在现有网络基础上再新建VLAN时，为了让这个VLAN能够互通，就需要在交换机间连接新的网线。建筑物楼层间的纵向布线是比较麻烦的，一般不能由基层管理人员随意进行。并且，VLAN越多，楼层间（严格地说是交换机间）互联所需的端口也越来越多，交换机端口的利用效率低是对资源的一种浪费、也限制了网络的扩展。

为了避免这种低效率的连接方式，人们想办法让交换机间互联的网线集中到一根上，这时使用的就是汇聚链接（Trunk Link）。

### 4.2、何谓汇聚链接？

汇聚链接（Trunk Link）指的是能够转发多个不同VLAN的通信的端口。

汇聚链路上流通的数据帧，都被附加了用于识别分属于哪个VLAN的特殊信息。

![img](https://img-blog.csdnimg.cn/f54cbd38749144e58b6fc41f603ecf1d.png)

### 假设A给C发送信息（同属于VLAN红色）

#### `TRUCK PVID = orange`

①、A发送的数据帧`从交换机Access接口进入交换机1，由于没有pvid,所以被打上与Access接口PID相同的VLAN=red标签`。当数据帧经过汇聚链路去往交换机2时，由于识别到数据帧的PVID与自身pvid不同，因此直接发出数据帧。

②、交换机2收到数据帧后，经过检查VLAN标识发现这个数据帧是属于红色VLAN的。

③、因此`交换机2会去除PVID=red标记，后根据需要将复原的数据帧只转发给其他属于PVID=red的VLAN的端口`。

这时的转送，是指经过确认目标MAC地址并与MAC地址列表比对后只转发给目标MAC地址所连的端口。

只有当数据帧是一个广播帧、多播帧或是目标不明的帧时，它才会被转发到所有属于红色VLAN的端口。

同理，蓝色VLAN发送数据帧时的情形也与此相同。

![VLAN10.png](https://ask.qcloudimg.com/http-save/3893317/rksja2yhih.png)

VLAN10.png

通过汇聚链路时附加的VLAN识别信息，有可能支持标准的“IEEE 802.1Q”协议，也可能是Cisco产品独有的“ISL（Inter Switch Link）”。如果交换机支持这些规格，那么用户就能够高效率地构筑横跨多台交换机的VLAN。

另外，汇聚链路上流通着多个VLAN的数据，自然负载较重。因此，在设定汇聚链接时，有一个前提就是必须支持100Mbps以上的传输速度。

另外，默认条件下，汇聚链接会转发交换机上存在的所有VLAN的数据。换一个角度看，可以认为汇聚链接（端口）同时属于交换机上所有的VLAN。由于实际应用中很可能并不需要转发所有VLAN的数据，因此为了减轻交换机的负载、也为了减少对带宽的浪费，我们可以通过用户设定限制能够经由汇聚链路互联的VLAN。

关于IEEE802.1Q和ISL的具体内容，将在下一讲中提到。











## **五、VLAN间路由**

### 5.1、VLAN间路由的必要性

根据目前为止学习的知识，我们已经知道两台计算机即使连接在同一台交换机上，只要所属的VLAN不同就无法直接通信。

接下来我们将要学习的就是如何在不同的VLAN间进行路由，使分属不同VLAN的主机能够互相通信。



### 5.2、使用路由器进行VLAN间路由

在使用路由器进行VLAN间路由时，与构建横跨多台交换机的VLAN时的情况类似，我们还是会遇到“该如何连接路由器与交换机”这个问题。路由器和交换机的接线方式，大致有以下两种：

● 将路由器与交换机上的每个VLAN分别连接

● 不论VLAN有多少个，路由器与交换机都只用一条网线连接

①、最容易想到的，当然还是“把路由器和交换机以VLAN为单位分别用网线连接”了。将交换机上用于和路由器互联的每个端口设为访问链接，然后分别用网线与路由器上的独立端口互联。如下图所示，交换机上有2个VLAN，那么就需要在交换机上预留2个端口用于与路由器互联；路由器上同样需要有2个端口；两者之间用2条网线分别连接。

![VLAN13.png](https://ask.qcloudimg.com/http-save/3893317/epbkxty008.png)

VLAN13.png

如果采用这个办法，大家应该不难想象它的扩展性很成问题。每增加一个新的VLAN，都需要消耗路由器的端口和交换机上的访问链接，而且还需要重新布设一条网线。而路由器，通常不会带有太多LAN接口的。新建VLAN时，为了对应增加的VLAN所需的端口，就必须将路由器升级成带有多个LAN接口的高端产品，这部分成本、还有重新布线所带来的开销，都使得这种接线法成为一种不受欢迎的办法。

②、那么，第二种办法“不论VLAN数目多少，都只用一条网线连接路由器与交换机”呢？当使用一条网线连接路由器与交换机、进行VLAN间路由时，需要用到汇聚链接。

具体实现过程为：首先将用于连接路由器的交换机端口设为汇聚链接，而路由器上的端口也必须支持汇聚链路。双方用于汇聚链路的协议自然也必须相同。接着在路由器上定义对应各个VLAN的“子接口（Sub Interface）”。尽管实际与交换机连接的物理端口只有一个，但在理论上我们可以把它分割为多个虚拟端口。

![VLAN14.png](https://ask.qcloudimg.com/http-save/3893317/jftnncmp7y.png)

VLAN14.png

VLAN将交换机从逻辑上分割成了多台，因而用于VLAN间路由的路由器，也必须拥有分别对应各个VLAN的虚拟接口。

采用这种方法的话，即使之后在交换机上新建VLAN，仍只需要一条网线连接交换机和路由器。用户只需要在路由器上新设一个对应新VLAN的子接口就可以了。

与前面的方法相比，这种方法扩展性要强得多，也不用担心需要升级LAN接口数不足的路由器或是重新布线。





### 5.3、同一VLAN内的通信时数据的流程

如下图所示，为各台计算机以及路由器的子接口设定IP地址。

![VLAN15.png](https://ask.qcloudimg.com/http-save/3893317/1ave6pkkde.png)

VLAN15.png

红色VLAN（VLAN ID=1）的网络地址为192.168.1.0/24，蓝色VLAN（VLAN ID=2）的网络地址为192.168.2.0/24。各计算机的MAC地址分别为A/B/C/D，路由器汇聚链接端口的MAC地址为R。交换机通过对各端口所连计算机MAC地址的学习，生成如下的MAC地址列表。

| 端口 | MAC地址 | VLAN |
| :--- | :------ | :--- |
| 1    | A       | 1    |
| 2    | B       | 1    |
| 3    | C       | 2    |
| 4    | D       | 2    |
| 5    | －      | －   |
| 6    | R       | 汇聚 |

首先考虑计算机A与同一VLAN内的计算机B之间通信时的情形。

（1）、计算机A发出ARP请求信息，请求解析B的MAC地址。

（2）、交换机收到数据帧后，检索MAC地址列表中与收信端口同属一个VLAN的表项。

（3）、结果发现，计算机B连接在端口2上，于是交换机将数据帧转发给端口2，最终计算机B收到该帧。

收发信双方同属一个VLAN之内的通信，一切处理均在交换机内完成。

![VLAN16.png](https://ask.qcloudimg.com/http-save/3893317/wbdgqotpms.png)

VLAN16.png

### 5.4、不同VLAN间通信时数据的流程

考虑一下计算机A与计算机C之间通信时的情况。

![VLAN17.png](https://ask.qcloudimg.com/http-save/3893317/ltwf6zkntl.png)

VLAN17.png

（1）、计算机A从通信目标的IP地址（192.168.2.1）得出C与本机不属于同一个网段。因此会向设定的默认网关（Default Gateway，GW）转发数据帧。在发送数据帧之前，需要先用ARP获取路由器的MAC地址。

（2）、得到路由器的MAC地址R后，接下来就是按图中所示的步骤发送往C去的数据帧。①的数据帧中，目标MAC地址是路由器的地址R、但内含的目标IP地址仍是最终要通信的对象C的地址。这一部分的内容，涉及到`局域网内经过路由器转发时的通信步骤`。

（3）、交换机在端口1上收到①的数据帧后，检索MAC地址列表中与端口1同属一个VLAN的表项。由于汇聚链路会被看作属于所有的VLAN，因此这时交换机的端口6也属于被参照对象。这样交换机就知道往MAC地址R发送数据帧，需要经过端口6转发。

从端口6发送数据帧时，由于它是汇聚链接，因此会被附加上VLAN识别信息。由于原先是来自红色VLAN的数据帧，因此如图中②所示，会被加上红色VLAN的识别信息后进入汇聚链路。

（4）、路由器收到②的数据帧后，确认其VLAN识别信息，由于它是属于红色VLAN的数据帧，因此交由负责红色VLAN的子接口接收。

接着，根据路由器内部的路由表，判断该向哪里中继。

由于目标网络192.168.2.0/24是蓝色VLAN，且该网络通过子接口与路由器直连，因此只要从负责蓝色VLAN的子接口转发就可以了。这时，数据帧的目标MAC地址被改写成计算机C的目标地址；并且由于需要经过汇聚链路转发，因此被附加了属于蓝色VLAN的识别信息。这就是图中③的数据帧。

（5）、交换机收到③的数据帧后，根据VLAN标识信息从MAC地址列表中检索属于蓝色VLAN的表项。由于通信目标——计算机C连接在端口3上、且端口3为普通的访问链接，因此交换机会将数据帧除去VLAN识别信息后（数据帧④）转发给端口3，最终计算机C才能成功地收到这个数据帧。

进行VLAN间通信时，即使通信双方都连接在同一台交换机上，也必须经过：“`发送方——交换机——路由器——交换机——接收方`”这样一个流程。













## **六、三层交换机**

### 6.1、使用路由器进行VLAN间路由时的问题

现在，我们知道只要能提供VLAN间路由，就能够使分属不同VLAN的计算机互相通信。

但是，如果使用路由器进行VLAN间路由的话，随着VLAN之间流量的不断增加，很可能导致路由器成为整个网络的瓶颈。

交换机使用被称为ASIC（Application Specified Integrated Circuit）的专用硬件芯片处理数据帧的交换操作，在很多机型上都能实现以缆线速度（Wired Speed）交换。而路由器，则基本上是基于软件处理的。

即使以缆线速度接收到数据包，也无法在不限速的条件下转发出去，因此会成为速度瓶颈。就VLAN间路由而言，流量会集中到路由器和交换机互联的汇聚链路部分，这一部分尤其特别容易成为速度瓶颈。

并且从硬件上看，由于需要分别设置路由器和交换机，在一些空间狭小的环境里可能连设置的场所都成问题。









### 6.2、三层交换机（Layer 3 Switch）

为了解决上述问题，三层交换机应运而生。`三层交换机，本质上就是“带有路由功能的（二层）交换机”`。路由属于OSI参照模型中第三层网络层的功能，因此带有第三层路由功能的交换机才被称为“三层交换机”。

关于三层交换机的内部结构，可以参照下面的简图。

![VLAN18.png](https://ask.qcloudimg.com/http-save/3893317/n01fmk1kxg.png)

VLAN18.png

在一台本体内，分别设置了交换机模块和路由器模块；而内置的路由模块与交换模块相同，使用`ASIC硬件处理路由`。因此，与传统的路由器相比，可以实现高速路由。并且，路由与交换模块是汇聚链接的，由于是内部连接，可以确保相当大的带宽。









### 6.3、使用三层交换机进行VLAN间路由（VLAN内通信）

在三层交换机内部数据究竟是怎样传播的呢？基本上，它和使用汇聚链路连接路由器与交换机时的情形相同。

假设有如下图所示的4台计算机与三层交换机互联。当使用路由器连接时，一般需要在LAN接口上设置对应各VLAN的子接口；而三层交换机则是在内部生成“VLAN接口（VLAN Interface）”。VLAN接口，是用于各VLAN收发数据的接口。

注：在Cisco的Catalyst系列交换机上，VLAN Interface被称为SVI——Switched Virtual Interface

![VLAN19.png](https://ask.qcloudimg.com/http-save/3893317/6kimiwtigr.png)

VLAN19.png

为了与使用路由器进行VLAN间路由对比，让我们同样来考虑一下计算机A与计算机B之间通信时的情况。首先是目标地址为B的数据帧被发到交换机；通过检索同一VLAN的MAC地址列表发现计算机B连在交换机的端口2上；因此将数据帧转发给端口2。









### 6.4、使用三层交换机进行VLAN间路由（VLAN间通信）

接下来设想一下计算机A与计算机C间通信时的情形。针对目标IP地址，计算机A可以判断出通信对象不属于同一个网络，因此向默认网关发送数据（Frame 1）。

交换机通过检索MAC地址列表后，经由内部汇聚链接，将数据帧转发给路由模块。在通过内部汇聚链路时，数据帧被附加了属于红色VLAN的VLAN识别信息（Frame 2）。

路由模块在收到数据帧时，先由数据帧附加的VLAN识别信息分辨出它属于红色VLAN，据此判断由红色VLAN接口负责接收并进行路由处理。因为目标网络192.168.2.0/24是直连路由器的网络、且对应蓝色VLAN；

因此，接下来就会从蓝色VLAN接口经由内部汇聚链路转发回交换模块。在通过汇聚链路时，这次数据帧被附加上属于蓝色VLAN的识别信息（Frame 3）。

交换机收到这个帧后，检索蓝色VLAN的MAC地址列表，确认需要将它转发给端口3。由于端口3是通常的访问链接，因此转发前会先将VLAN识别信息除去（Frame 4）。最终，计算机C成功地收到交换机转发来的数据帧。

![VLAN20.png](https://ask.qcloudimg.com/http-save/3893317/jno6g9m2i4.png)

VLAN20.png

整体的流程，与使用外部路由器时的情况十分相似——都需要经过“`发送方→交换模块→路由模块→交换模块→接收方`”这样的流程。













## **七、加速VLAN间通信的手段**

### 7.1、流（Flow）

根据到此为止的学习，我们已经知道VLAN间路由，必须经过外部的路由器或是三层交换机的内置路由模块。但是，有时并不是所有的数据都需要经过路由器（或路由模块）。

例如，使用FTP（File Transfer Protocol）传输容量为数MB以上的较大的文件时，由于MTU的限制，IP协议会将数据分割成小块后传输、并在接收方重新组合。这些被分割的数据，“发送的目标”是完全相同的。发送目标相同，也就意味着同样的目标IP地址、目标端口号（注：特别强调一下，这里指的是TCP/UDP端口）。自然，源IP地址、源端口号也应该相同。这样一连串的数据流被称为“流（Flow）”。

![VLAN21.png](https://ask.qcloudimg.com/http-save/3893317/83gryjbgkz.png)

VLAN21.png

只要将流最初的数据正确地路由以后，后继的数据理应也会被同样地路由。

据此，后继的数据不再需要路由器进行路由处理；通过省略反复进行的路由操作，可以进一步提高VLAN间路由的速度。









### 7.2、加速VLAN间路由的机制

接下来，让我们具体考虑一下该如何使用三层交换机进行高速VLAN间路由。

首先，整个流的第一块数据，照常由交换机转发→路由器路由→再次由交换机转发到目标所连端口。这时，将第一块数据路由的结果记录到缓存里保存下来。需要记录的信息有：

● 目标IP地址

● 源IP地址

● 目标TCP/UDP端口号

● 源TCP/UDP端口号

● 接收端口号（交换机）

● 转发端口号（交换机）

● 转发目标MAC地址

...

等等。

同一个流的第二块以后的数据到达交换机后，直接通过查询先前保存在缓存中的信息查出“转发端口号”后就可以转发给目标所连端口了。

这样一来，就不需要再一次次经由内部路由模块中继，而仅凭交换机内部的缓存信息就足以判断应该转发的端口。

这时，交换机会对数据帧进行由路由器中继时相似的处理，例如改写MAC地址、IP包头中的TTL和Check Sum校验码信息等。

![VLAN22.png](https://ask.qcloudimg.com/http-save/3893317/33uzdl4yzj.png)

VLAN22.png

通过在交换机上缓存路由结果，实现了以缆线速度（Wired Speed）接收发送方传输来数据的数据、并且能够全速路由、转发给接收方。

需要注意的是，类似的加速VLAN间路由的手法多由各厂商独有的技术所实现，并且该功能的称谓也因厂商而异。例如，在Cisco的Catalyst系列交换机上，这种功能被称为“多层交换（Multi Layer Switching）”。

另外，除了三层交换机的内部路由模块，外部路由器中的某些机型也支持类似的高速VLAN间路由机制。













## **八、传统型路由器存在的意义**

### 8.1、路由器的必要性

三层交换机的价格，在问世之初非常昂贵，但是现在它们的价格已经下降了许多。目前国外一些廉价机型的售价，折合成人民币后仅为一万多元，而且还在继续下降中。

既然三层交换机能够提供比传统型路由器更为高速的路由处理，那么网络中还有使用路由器的必要吗？

答案是：“是”。

使用路由器的必要性，主要表现在以下几个方面：

■ 用于与WAN连接

三层交换机终究是“交换机”。也就是说，绝大多数机型只配有LAN（以太网）接口。在少数高端交换机上也有用于连接WAN的串行接口或是ATM接口，但在大多数情况下，连接WAN还是需要用到路由器。

■ 保证[网络安全](https://cloud.tencent.com/product/ns?from_column=20065&from=20065)

在三层交换机上，通过数据包过滤也能确保一定程度的网络安全。但是使用路由器所提供的各种网络安全功能，用户可以构建更为安全可靠的网络。

路由器提供的网络安全功能中，除了最基本的数据包过滤功能外，还能基于IPSec构建×××（Virtual Private Network）、利用RADIUS进行用户认证等等。

■ 支持除TCP/IP以外的网络架构

尽管TCP/IP已经成为当前网络协议架构的主流，但还有不少网络利用Novell Netware下的IPX/SPX或Macintosh下的Appletalk等网络协议。三层交换机中，除了部分高端机型外基本上还只支持TCP/IP。因此，在需要使用除TCP/IP之外其他网络协议的环境下，路由器还是必不可少的。

注：在少数高端交换机上，也能支持上述路由器的功能。例如Cisco的Catalyst6500系列，就可以选择与WAN连接的接口模块；还有可选的基于IPSec实现×××的模块；并且也能支持TCP/IP以外的其他网络协议。









### 8.2、路由器和交换机配合构建LAN的实例

下面让我们来看一个路由器和交换机搭配构建LAN的实例。

![VLAN23.png](https://ask.qcloudimg.com/http-save/3893317/3wvic28q77.png)

VLAN23.png

利用在各楼层配置的二层交换机定义VLAN，连接TCP/IP客户计算机。各楼层间的VLAN间通信，利用三层交换机的高速路由加以实现。如果网络环境要求高可靠性，还可以考虑冗余配置三层交换机。

与WAN的连接，则通过带有各种网络接口的路由器进行。并且，通过路由器的数据包过滤和×××等功能实现网络安全。此外，使用路由器还能支持Novell Netware等TCP/IP之外的网络。

只有在充分掌握了二层、三层交换机以及传统路由器的基础上，才能做到物竞其用，构筑出高效率、高性价比的网络。













## **九、使用VLAN设计局域网**

### 9.1、使用VLAN设计局域网的特点

通过使用VLAN构建局域网，用户能够不受物理链路的限制而自由地分割广播域。

另外，通过先前提到的路由器与三层交换机提供的VLAN间路由，能够适应灵活多变的网络构成。

但是，由于利用VLAN容易导致网络构成复杂化，因此也会造成整个网络的组成难以把握。

可以这样说，在利用VLAN时，除了有：

●网络构成灵活多变

这个优点外，还搭配着：

●网络构成复杂化

这个缺点。

下面，就让我们来看看具体的实例。









### 9.2、不使用VLAN的局域网中网络构成的改变

假设有如图所示的由1台路由器、2台交换机构成的“不使用VLAN构建”的网络。

![VLAN24.png](https://ask.qcloudimg.com/http-save/3893317/sszcqqj75x.png)

VLAN24.png

图中的路由器，带有2个LAN接口。左侧的网络是192.168.1.0/24，右侧是192.168.2.0/24。

现在如果想将192.168.1.0/24这个网络上的计算机A转移到192.168.2.0/24上去，就需要改变物理连接、将A接到右侧的交换机上。

并且，当需要新增一个地址为192.168.3.0/24的网络时，还要在路由器上再占用一个LAN接口并添置一台交换机。而由于这台路由器上只带了2个LAN接口，因此为了新增网络还必须将路由器升级为带有3个以上LAN接口的产品。









### 9.3、使用VLAN的局域网中网络构成的改变

接下来再假设有一个由1台路由器、2台交换机构成的“使用VLAN”的局域网。交换机与交换机、交换机与路由器之间均为汇聚链路；并且假设192.168.1.0/24对应红色VLAN、192.168.2.0/24对应蓝色VLAN。

![VLAN25.png](https://ask.qcloudimg.com/http-save/3893317/qg138a8qn3.png)

VLAN25.png

需要将连接在交换机1上192.168.1.0/24这个网段的计算机A转属192.168.2.0/24时，无需更改物理布线。只要在交换机上生成蓝色VLAN，然后将计算机A所连的端口1加入到蓝色VLAN中去，使它成为访问链接即可。

然后，根据需要设定计算机A的IP地址、默认网关等信息就可以了。如果IP地址相关的设定是由DHCP获取的，那么在客户机方面无需进行任何设定修改，就可以在不同网段间移动。

利用VLAN后，我们可以在免于改动任何物理布线的前提下，自由进行网络的逻辑设计。如果所处的工作环境恰恰需要经常改变网络布局，那么利用VLAN的优势就非常明显了。

并且，当需要新增一个地址为192.168.3.0/24的网段时，也只需要在交换机上新建一个对应192.168.3.0/24的VLAN，并将所需的端口加入它的访问链路就可以了。

如果网络环境中还需要利用外部路由器，则只要在路由器的汇聚端口上新增一个子接口的设定就可以完成全部操作，而不需要消耗更多的物理接口（LAN接口）。要使用的是三层交换机内部的路由模块，则只需要新设一个VLAN接口即可。

网络环境的成长，往往是难以预测的，很可能经常会出现需要分割现有网络或是增加新网络的情况。而充分活用VLAN后，就可以轻易地解决这些问题。









### 9.4、利用VLAN而导致的网络结构复杂化

虽然利用VLAN可以灵活地构建网络，但是同时，它也带来了网络结构复杂化的问题。

特别是由于数据流纵横交错，一旦发生故障时，准确定位并排除故障会比较困难。

为了便于理解数据流向的复杂化，假设有下图所示的网络。计算机A向计算机C发送数据时，数据流的整体走向如下：

计算机A→交换机1→路由器→交换机1→交换机2→计算机C

![VLAN26.png](https://ask.qcloudimg.com/http-save/3893317/5cm7mbu5s9.png)

VLAN26.png

（1）、首先计算机A向交换机1送出数据（①）

（2）、其后数据被转发给路由器（②）进行VLAN间路由。

（3）、路由后的数据，再从汇聚链路返回交换机1（③）。

（4）、由于通信目标计算机C并不直连在交换机1上，因此还需要经过汇聚链路转发到交换机2（④）。

（5）、在交换机2上，数据最终被转发到C所连的端口2上，这才完成整个流程（⑤）。

在这个例子中，仅由2台交换机构成网络，其数据流已经如此复杂，如果构建横跨多台交换机的VLAN的话，每个数据流的流向显然会更加难以把握。









### 9.5、网络的逻辑结构与物理结构

为了对应日渐复杂化的数据流，管理员需要从“逻辑结构”与“物理结构”两方面入手，把握好网络的现状。

物理结构，指的是从物理层和数据链路层观察到的网络的现状，表示了网络的物理布线形态和VLAN的设定等等。

而逻辑结构，则表示从网络层以上的层面观察到的网络结构。下面我们就试着以路由器为中心分析一个IP网络的逻辑结构。

还是先前的那个例子，描绘了布线形态和VLAN设定的“物理结构”如下图所示。

![VLAN27.png](https://ask.qcloudimg.com/http-save/3893317/js7tk3ma81.png)

VLAN27.png

分析这个物理结构并转换成以路由器为中心的逻辑结构后，会得到如下的逻辑结构图。当我们需要进行路由或是数据包过滤的设定时，都必须在逻辑结构的基础上进行。

![VLAN28.png](https://ask.qcloudimg.com/http-save/3893317/mwngyr23u6.png)

VLAN28.png

把握这两种网络结构图的区别是十分重要的，特别是在VLAN和三层交换机大行其道的现代企业级网络当中。

